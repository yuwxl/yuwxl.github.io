

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/dog.jpg">
  <link rel="icon" href="/img/dog.jpg">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="nayun">
  <meta name="keywords" content="">
  
    <meta name="description" content="2022&#x2F;学习&#x2F;北大肖榛     比特币中的密码学原理 hash函数 和 数字签名 hash 函数需要满足  collision resistance性质（但不绝对，非哈希碰撞证明不出来） hiding  x-&gt;h(x)  从h(x)推不出x collision resistance + hiding 可以实现 digital commitment&#x2F;digital equivalent of">
<meta property="og:type" content="article">
<meta property="og:title" content="Blockchain-basics">
<meta property="og:url" content="https://yuwxl.github.io/2023/01/04/Blockchain-basics/index.html">
<meta property="og:site_name" content="yu&#39;s blog">
<meta property="og:description" content="2022&#x2F;学习&#x2F;北大肖榛     比特币中的密码学原理 hash函数 和 数字签名 hash 函数需要满足  collision resistance性质（但不绝对，非哈希碰撞证明不出来） hiding  x-&gt;h(x)  从h(x)推不出x collision resistance + hiding 可以实现 digital commitment&#x2F;digital equivalent of">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://yuwxl.github.io/images/Blockchain-basics.assets/image-20220923104503998.png">
<meta property="og:image" content="https://yuwxl.github.io/images/Blockchain-basics.assets/image-20220923104733985.png">
<meta property="og:image" content="https://yuwxl.github.io/images/Blockchain-basics.assets/image-20220923104749972.png">
<meta property="og:image" content="https://yuwxl.github.io/images/Blockchain-basics.assets/image-20220923113101710.png">
<meta property="og:image" content="https://yuwxl.github.io/images/Blockchain-basics.assets/image-20220923113703982.png">
<meta property="og:image" content="https://yuwxl.github.io/images/Blockchain-basics.assets/image-20220923115202061.png">
<meta property="og:image" content="https://yuwxl.github.io/images/Blockchain-basics.assets/image-20220925103515818.png">
<meta property="og:image" content="https://yuwxl.github.io/images/Blockchain-basics.assets/image-20221104115814175.png">
<meta property="og:image" content="https://yuwxl.github.io/images/Blockchain-basics.assets/image-20221104163050417.png">
<meta property="og:image" content="https://yuwxl.github.io/images/Blockchain-basics.assets/image-20221104163249141.png">
<meta property="og:image" content="https://yuwxl.github.io/images/Blockchain-basics.assets/image-20221106211347241.png">
<meta property="og:image" content="https://yuwxl.github.io/images/Blockchain-basics.assets/image-20221106211406571.png">
<meta property="og:image" content="https://yuwxl.github.io/images/Blockchain-basics.assets/image-20221104212616029.png">
<meta property="og:image" content="https://yuwxl.github.io/images/Blockchain-basics.assets/image-20221104212704927.png">
<meta property="og:image" content="https://yuwxl.github.io/images/Blockchain-basics.assets/image-20221104213203037.png">
<meta property="og:image" content="https://yuwxl.github.io/images/Blockchain-basics.assets/image-20221104213344864.png">
<meta property="og:image" content="https://yuwxl.github.io/images/Blockchain-basics.assets/image-20221104213443852.png">
<meta property="og:image" content="https://yuwxl.github.io/images/Blockchain-basics.assets/image-20221104213615099.png">
<meta property="og:image" content="https://yuwxl.github.io/images/Blockchain-basics.assets/image-20221104214048239.png">
<meta property="og:image" content="https://yuwxl.github.io/images/Blockchain-basics.assets/image-20221104214645320.png">
<meta property="og:image" content="https://yuwxl.github.io/images/Blockchain-basics.assets/image-20221106114602715.png">
<meta property="og:image" content="https://yuwxl.github.io/images/Blockchain-basics.assets/image-20221106115103753.png">
<meta property="og:image" content="https://yuwxl.github.io/images/Blockchain-basics.assets/image-20221106115341448.png">
<meta property="og:image" content="https://yuwxl.github.io/images/Blockchain-basics.assets/image-20221106115444823.png">
<meta property="og:image" content="https://yuwxl.github.io/images/Blockchain-basics.assets/image-20221106150032510.png">
<meta property="og:image" content="https://yuwxl.github.io/images/Blockchain-basics.assets/image-20221106150955674.png">
<meta property="og:image" content="https://yuwxl.github.io/images/Blockchain-basics.assets/image-20221106151243198.png">
<meta property="og:image" content="https://yuwxl.github.io/images/Blockchain-basics.assets/image-20221106151447135.png">
<meta property="og:image" content="https://yuwxl.github.io/images/Blockchain-basics.assets/image-20221106152028684.png">
<meta property="og:image" content="https://yuwxl.github.io/images/Blockchain-basics.assets/image-20221106152306021.png">
<meta property="og:image" content="https://yuwxl.github.io/images/Blockchain-basics.assets/image-20221106153236557.png">
<meta property="og:image" content="https://yuwxl.github.io/images/Blockchain-basics.assets/image-20221106160223541.png">
<meta property="og:image" content="https://yuwxl.github.io/images/Blockchain-basics.assets/image-20221106160519077.png">
<meta property="og:image" content="https://yuwxl.github.io/images/Blockchain-basics.assets/image-20221106161051158.png">
<meta property="og:image" content="https://yuwxl.github.io/images/Blockchain-basics.assets/image-20221106164034705.png">
<meta property="og:image" content="https://yuwxl.github.io/images/Blockchain-basics.assets/image-20221106192823012.png">
<meta property="og:image" content="https://yuwxl.github.io/images/Blockchain-basics.assets/image-20221106193354921.png">
<meta property="og:image" content="https://yuwxl.github.io/images/Blockchain-basics.assets/image-20221106194005112.png">
<meta property="og:image" content="https://yuwxl.github.io/images/Blockchain-basics.assets/image-20221106194221468.png">
<meta property="og:image" content="https://yuwxl.github.io/images/Blockchain-basics.assets/image-20220816100406870.png">
<meta property="og:image" content="https://yuwxl.github.io/images/Blockchain-basics.assets/image-20220816100633628.png">
<meta property="og:image" content="https://yuwxl.github.io/images/Blockchain-basics.assets/image-20220818085143127.png">
<meta property="og:image" content="https://yuwxl.github.io/images/Blockchain-basics.assets/image-20220818085755713.png">
<meta property="og:image" content="https://yuwxl.github.io/images/Blockchain-basics.assets/image-20220818093231959.png">
<meta property="og:image" content="https://yuwxl.github.io/images/Blockchain-basics.assets/image-20220818093443722.png">
<meta property="og:image" content="https://yuwxl.github.io/images/Blockchain-basics.assets/image-20220818105756354.png">
<meta property="og:image" content="https://yuwxl.github.io/images/Blockchain-basics.assets/image-20220818112731881.png">
<meta property="og:image" content="https://yuwxl.github.io/images/Blockchain-basics.assets/image-20220818155712239.png">
<meta property="og:image" content="https://yuwxl.github.io/images/Blockchain-basics.assets/image-20220818160942667.png">
<meta property="og:image" content="https://yuwxl.github.io/images/Blockchain-basics.assets/image-20220818164019025.png">
<meta property="og:image" content="https://yuwxl.github.io/images/Blockchain-basics.assets/image-20220818165614862.png">
<meta property="og:image" content="https://yuwxl.github.io/images/Blockchain-basics.assets/image-20220818170118103.png">
<meta property="og:image" content="https://yuwxl.github.io/images/Blockchain-basics.assets/image-20220818170515230.png">
<meta property="og:image" content="https://yuwxl.github.io/images/Blockchain-basics.assets/image-20220818170954917.png">
<meta property="og:image" content="https://yuwxl.github.io/images/Blockchain-basics.assets/image-20220819085759104.png">
<meta property="og:image" content="https://yuwxl.github.io/images/Blockchain-basics.assets/image-20220819090015863.png">
<meta property="og:image" content="https://yuwxl.github.io/images/Blockchain-basics.assets/image-20220819090611351.png">
<meta property="og:image" content="https://yuwxl.github.io/images/Blockchain-basics.assets/image-20220822104845720.png">
<meta property="og:image" content="https://yuwxl.github.io/images/Blockchain-basics.assets/image-20220822111654641.png">
<meta property="og:image" content="https://yuwxl.github.io/images/Blockchain-basics.assets/image-20220822112840189.png">
<meta property="og:image" content="https://yuwxl.github.io/images/Blockchain-basics.assets/image-20220822113318971.png">
<meta property="og:image" content="https://yuwxl.github.io/images/Blockchain-basics.assets/image-20220822113921326.png">
<meta property="og:image" content="https://yuwxl.github.io/images/Blockchain-basics.assets/image-20220822114014942.png">
<meta property="og:image" content="https://yuwxl.github.io/images/Blockchain-basics.assets/image-20220822114554106.png">
<meta property="og:image" content="https://yuwxl.github.io/images/Blockchain-basics.assets/image-20220822115545201.png">
<meta property="article:published_time" content="2023-01-04T02:58:24.000Z">
<meta property="article:modified_time" content="2023-05-03T11:27:02.000Z">
<meta property="article:author" content="nayun">
<meta property="article:tag" content="基础知识">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://yuwxl.github.io/images/Blockchain-basics.assets/image-20220923104503998.png">
  
  
  
  <title>Blockchain-basics - yu&#39;s blog</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"yuwxl.github.io","root":"/","version":"1.9.4","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 5.4.2"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>nana</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/tina.jpg') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="Blockchain-basics"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2023-01-04 10:58" pubdate>
          2023年1月4日 上午
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          13k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          111 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">Blockchain-basics</h1>
            
            
              <div class="markdown-body">
                
                <h3 id="2022-学习-北大肖榛"><a href="#2022-学习-北大肖榛" class="headerlink" title="2022/学习/北大肖榛"></a>2022/学习/北大肖榛</h3><blockquote>
<p><img src="/images/Blockchain-basics.assets/image-20220923104503998.png" srcset="/img/loading.gif" lazyload alt="image-20220923104503998" style="zoom:50%;"></p>
<p><img src="/images/Blockchain-basics.assets/image-20220923104733985.png" srcset="/img/loading.gif" lazyload alt="image-20220923104733985" style="zoom:50%;"></p>
<p><img src="/images/Blockchain-basics.assets/image-20220923104749972.png" srcset="/img/loading.gif" lazyload alt="image-20220923104749972" style="zoom:50%;"></p>
</blockquote>
<h4 id="比特币中的密码学原理"><a href="#比特币中的密码学原理" class="headerlink" title="比特币中的密码学原理"></a>比特币中的密码学原理</h4><blockquote>
<p>hash函数 和 数字签名</p>
<p><strong>hash 函数</strong>需要满足</p>
<ol>
<li>collision resistance性质（但不绝对，非哈希碰撞证明不出来）</li>
<li>hiding  x-&gt;h(x)  从h(x)推不出x</li>
<li>collision resistance + hiding 可以实现 <strong>digital commitment</strong>/digital equivalent of sealed envelope (预测结果不能提前公布，但是可以公布hash值，之后再验证预测值)</li>
<li>puzzle friendly  光从x无法判断h(x)的大致范围(挖矿就是找一个nonce,这个随机数和区块链块头的数字合起来，取hash,落在指定的范围之内，找随机数方法没有捷径)</li>
</ol>
<p>实际操作中为了使样本均匀，x经常补全一些随即数 x||nonce</p>
<p>比特币中用的hash函数是SHA-256(Secure Hash Algorithm)</p>
<p><strong>数字签名</strong></p>
<p>比特币开户的过程：创立公钥和私钥对（非对称加密体系，asymmetric encryption algorithm）生成公私钥时要有好的随机源，不然容易被破解</p>
</blockquote>
<h4 id="比特币中的数据结构"><a href="#比特币中的数据结构" class="headerlink" title="比特币中的数据结构"></a>比特币中的数据结构</h4><blockquote>
<p>hash指针 ：保存结构体的位置，以及结构体的hash值（可验证篡改</p>
<p>区块链就是使用hash指针的链表，每个区块包含指向前一个区块的hash指针，当有篡改时，后面所有的验证都不通过，我保存的hash值会感知到篡改（牵一发而动全身），所有可以只保存后几个新区块不用保存所有</p>
<p><img src="/images/Blockchain-basics.assets/image-20220923113101710.png" srcset="/img/loading.gif" lazyload alt="image-20220923113101710"></p>
<p>第二个数据结构：merkle tree </p>
<p>最后一层是数据块，其余是hash指针，根节点也可以取hash ，root hash，只要保存了根hash，就能检测任何区块的修改。每个数据块是一个交易。</p>
<p><img src="/images/Blockchain-basics.assets/image-20220923113703982.png" srcset="/img/loading.gif" lazyload alt="image-20220923113703982"></p>
<p>比特币中每个区块通过hash指针连在一起，每个区块<strong>所包含的交易组织成一个merkle tree</strong>的形式</p>
<p>每个<strong>区块</strong>分为 块头（block header）和块身(block body)，块头存放 root hash值，块身存放交易列表</p>
<p>merkle  tree 作用：提供 <strong>merkle proof</strong> 例如手机端的轻结点只保存block header</p>
<p>假设某轻节点想要知道某个交易(图中黄色)是否包含在这个merkle tree中，但它只有一个root hash. 全节点接受到proof请求，发送三个红色的hash值，轻节点可以在本地通过和红色的组合来计算出绿色的hash，最终算出root hash ,和block header里面的root hash 对比，即可验证黄色tx是否存在这棵树上。（proof of membership）</p>
<p><img src="/images/Blockchain-basics.assets/image-20220923115202061.png" srcset="/img/loading.gif" lazyload alt="image-20220923115202061"></p>
<p>怎么证明这棵树上没有某个交易tx? </p>
<p>按照hash值排序</p>
</blockquote>
<h4 id="BTC协议"><a href="#BTC协议" class="headerlink" title="BTC协议"></a>BTC协议</h4><blockquote>
<p>暂时不考虑去中心化，如果央行要发行电子货币：</p>
<p>数字货币相当于一个文件，虽然不能伪造，但是可以复制（要防止<strong>双花攻击</strong>）</p>
<p>但任何两个人之间的交易都要通过央行确认、记录</p>
<p>解决以上问题，引入一种数据结构，区块链</p>
<p><img src="/images/Blockchain-basics.assets/image-20220925103515818.png" srcset="/img/loading.gif" lazyload alt="image-20220925103515818"></p>
<p>有两种hash指针，一种是讲区块连接起来的指针，另一种是表示币的来源（防范double spending） ,实际交易中，每个区块包括多个交易。</p>
<p>block header:使用区块链哪个版本的协议、指向前一个区块的指针、整颗merkel树的root hash、挖矿的目标阈值、随机数</p>
<p>block body:交易链表，取hash时只管 block header,block body由  root hash保证不可篡改性</p>
<p>分布式共识-分布式hash表</p>
<p>FLP impossiblity result  :  在异步的系统中，即使只有一个成员是有问题的，就不能在系统中达成共识</p>
<p>CAP Theorem : consistency availability partition tolerance</p>
<p>Paxos 协议</p>
<p>联盟链：不是谁都能加入 hyperledger(适合基于投票决定下一个区块-fabric)</p>
<p>女巫攻击： cybil attack</p>
</blockquote>
<p>区块分为 </p>
<div class="table-container">
<table>
<thead>
<tr>
<th>block header</th>
<th>block body</th>
</tr>
</thead>
<tbody>
<tr>
<td>比特币哪个版本协议</td>
<td>tx  list(交易列表)</td>
</tr>
<tr>
<td>指向前一个区块的hash指针</td>
<td></td>
</tr>
<tr>
<td>默克尔树根hash（保证body中的交易不被篡改）</td>
<td></td>
</tr>
<tr>
<td>target(难度目标阈值)</td>
<td></td>
</tr>
<tr>
<td>nonce（随机数）</td>
</tr>
</tbody>
</table>
</div>
<blockquote>
<p> H(block header) &lt;= target  （target是由比特币官方发布？？？）</p>
<p> block hearder存 nbits目标阈值的编码，<strong>指向前一个区块的hash只算区块的块头</strong></p>
</blockquote>
<p>节点分为：全节点(保存区块链所有信息，可以验证交易)、轻节点(只保存header,无法验证交易)，全节点比较少，大部分是轻节点</p>
<p>交易是如何写到区块链中？<strong>账本的内容要取得分布式的共识。</strong>distributed consensus</p>
<p>分布式hash表的研究中：有很多不可能结论——如下</p>
<blockquote>
<p>FLP :在异步的系统中，只要有一个节点是不诚实的，就无法达成共识</p>
<p>CAP理论：一致性、可用性、分区容错，不可能三角</p>
</blockquote>
<p>分布式共识著名协议：Paxos——共识是键值对</p>
<p>比特币中的共识协议</p>
<blockquote>
<p>思考：如果投票行不行，先打包一个候选区块，广播给所有节点，然后投票，如果恶意节点，每次都打包恶意交易，大家不停的投票，区块链无法继续下去；或者某些节点懒，谁的区块我都不投票。所以，任何以投票为基础的区块链，首先要确定谁有投票权，比如联盟链。</p>
<p>在比特币中，任何节点都能在本地产生公私钥对加入区块链，那假设某个恶意机器不停的产生账户，一旦超过50%，它就可以控制区块链，如果是投票机制的话，大于半数的票会被控制。——女巫攻击。（本地产生公私钥对其他人不知道，只有转账交易的时候才知道）</p>
<p>故，简单的直接投票不可行。</p>
<p><strong>比特币中基于算力“投票”</strong></p>
<p>H(block header) &lt;= target 找到 正确的nonce,其他节点验证：先看block hearder 中的nBits（目标阈值范围）是不是符合难度要求，再验证算出来的nonce是不是满足上述不等式，验证body中的交易合法性。</p>
<p>如果验证了某个区块都是合法的，是否也存在不想要接收的情况？——存在</p>
<p>接收到一个区块，怎么知道它插在哪里？——根据hash of prev block</p>
<p><img src="/images/Blockchain-basics.assets/image-20221104115814175.png" srcset="/img/loading.gif" lazyload alt="image-20221104115814175"></p>
<p>下面这个分支，验证是合法的，但是不在最长合法链上，如果被接收了，相当于把A-&gt;B交易回滚了，所有不能接收。——分叉攻击</p>
<p>区块链在正常情况下也可能出现分叉，当出现两个等长的分叉，该接受哪个呢，不同网络节点中可能先后听到不同的区块，临时性分叉会维持一段时间，直到某一分叉胜出。另一个分叉就是orphan block。</p>
<p>为什么要争夺记账权？——出块奖励 coinbase transaction (发行新比特币的唯一方法)</p>
<p>比特币要取得的共识是什么？——账本的内容</p>
</blockquote>
<h4 id="BTX实现——transaction-based-ledger"><a href="#BTX实现——transaction-based-ledger" class="headerlink" title="BTX实现——transaction-based ledger"></a>BTX实现——transaction-based ledger</h4><p>比特币系统中的全节点要维护一个叫UTXO 的数据结构(unspent transaction output)，想要花掉的币必须在UTXO 中，总输入 == 总输出</p>
<p>发布区块的节点为啥要把某个包打包到区块链中？——有gas费（不光是出块奖励）</p>
<p>比特币是基于交易的账本，所有每个交易都要说明每个币是从哪里来的</p>
<p>account-based ledger 基于账户的账本（以太坊）</p>
<p>每次尝试一个nonce,相当于一个Bernoulli trial: a random experiment with binary outcome,这些Bernoulli trial 构成一个Bernoulli process: a sequence of independent Bernolli trails,是无记忆性的</p>
<p>实验次数很多时，变成泊松过程，出块时间服从指数分布，progress free,不会因为之前的工作而影响后面的工作</p>
<p><strong>区块插在哪个位置在一开始挖矿的时候就是确定的，因为block-header里要填前一个block的hash</strong></p>
<p>分叉攻击代价很大，等待6个确认之后，两个分叉的链竞赛</p>
<p>特殊情况：selfish mining 自己悄咪咪挖一直挖不发布，一直挖到超过上一个分叉链，等到收到货了（交易在上一个分叉中），一下子发布，企图覆盖上一个分叉区块</p>
<p>缺省设置：节点接收最先听到的交易</p>
<h4 id="比特币网络-工作原理"><a href="#比特币网络-工作原理" class="headerlink" title="比特币网络-工作原理"></a>比特币网络-工作原理</h4><blockquote>
<p>比特币工作在应用层（没有超级节点和主节点）</p>
<p>底层是p2p网络</p>
<p>加入比特币网络过程：与种子节点联系，它会告诉你它所知道的其他节点，节点之间通过TCP进行联系，有利于穿透防火墙</p>
</blockquote>
<p>simple,robust,but not efficient</p>
<p>每个节点维护一个邻居节点的集合，节点第一次听到某一个交易时，转发给所有邻居节点(flooding)，每个节点维护一个等待上链的区块链的交易集合，如果听到某一交易已经被写入区块链，从集合中删除这个交易</p>
<p>某一个交易发布到网络中，不一定每个节点都能收到，并且收到的顺序也不一样，有的节点收到了故意不转发，不按照规则，best effort</p>
<h4 id="挖矿难度的调整"><a href="#挖矿难度的调整" class="headerlink" title="挖矿难度的调整"></a>挖矿难度的调整</h4><p>H(block header) &lt;= target （target越小，挖矿难度越大，目标在整个空间中占比越小）</p>
<p>比特币用的hash算法是SHA-256</p>
<p>difficulty = difficult_1_target / target</p>
<p>为什么要调整挖矿难度?——出块时间越来越短会带来什么问题，会经常出现分叉，分叉过多严重影响效率。以太坊出块时间15秒，但要设计一个新的共识机制，ghost.对孤块也会有奖励，以太坊也要调整挖矿难度，保证出块时间的稳定。</p>
<p>比特币中规定，每隔2016个区块，就要调整挖矿难度，大概是两周（10min一个区块）。</p>
<blockquote>
<p>target = target * (actual time / expected time) </p>
<p>当实际所用时间大于2周，target变大，挖矿难度降低；当小于2周，target变小，挖矿难度变大。上下调整4倍为阈值</p>
<p>如何让大家都按照这个规则调整挖矿难度？——调整规则写在比特币代码里面，自动调整，但是代码是开源的，恶意节点可以故意不调整。但是此时target(256位)已经改变了，在header里面以nBits来存储target(压缩编码)，检测时，不调整的话其他节点不承认。</p>
</blockquote>
<h4 id="比特币挖矿"><a href="#比特币挖矿" class="headerlink" title="比特币挖矿"></a>比特币挖矿</h4><blockquote>
<p><img src="/images/Blockchain-basics.assets/image-20221104163050417.png" srcset="/img/loading.gif" lazyload alt="image-20221104163050417"></p>
<p><img src="/images/Blockchain-basics.assets/image-20221104163249141.png" srcset="/img/loading.gif" lazyload alt="image-20221104163249141"></p>
<p>只转账不挖矿，用轻节点就可以了。如果挖矿过程中听到区块链上已经挖出来了，要停止挖矿，重新组装交易，形成新的待上链集合。header会发生变化。 </p>
<p>挖矿设备（通用-&gt;专用）：</p>
<p>1、用通用计算机挖矿，hash计算只用到部分cpu指令集，内存有很多闲置，不划算</p>
<p>2、用GPU（通用并行计算），但很多操作指令也用不到，也不划算，不如用深度学习</p>
<p>3、用ASIC 芯片挖矿（专门用来挖矿，为某一加密货币设计的ASIC，除非mining puzzle一样，不如一个芯片只能为一种加密货币挖矿）</p>
<p>矿工按照通讯协议和矿主联系，矿主分配hash任务，矿工返回hash值。 </p>
</blockquote>
<h4 id="比特币引发的思考"><a href="#比特币引发的思考" class="headerlink" title="比特币引发的思考"></a>比特币引发的思考</h4><blockquote>
<p>1、hash指针，并不是真的指针，发布到网络的区块，header存的就是上一个区块的hash值而已，全节点把这些hash值存在一个（key,value）数据库中，levelDB,将所有区块串起来。</p>
<p>2、多个人保存私钥，不要用截断的方式，这样很容易猜到另外的片段，要用多重签名</p>
<p>3、比特币并不是把公钥直接暴露，而是提供公钥的hash,如果只是收钱，提供公钥的hash即可，取钱时才需要公钥 + 私钥签名，量子计算机也无法从公钥的hash推导出公钥。或者取钱之后，地址就丢弃，钱一下子取完。如果担心量子计算的威胁的话。</p>
</blockquote>
<h4 id="以太坊概述"><a href="#以太坊概述" class="headerlink" title="以太坊概述"></a>以太坊概述</h4><blockquote>
<p>1.重新设计共识机制ghost</p>
<p>2.不同的 mining puzzle,以太坊设计的mining puzzle对内存要求高，限制了ASIC芯片的使用，并且用权益证明来代替工作量证明</p>
<p>3.对智能合约的支持</p>
<p>为什么要用智能合约？——如果我们可以将货币去中心化，那还有什么可以去中心化？——去中心化合约，不是所有的合同都可以用编程语言实现，一些逻辑简单的合同可以放到智能合约中。</p>
<p>应用场景：比特币-跨国转账</p>
<p>智能合约：跨国交易（难以用司法手段维护权益）</p>
<p>BTC </p>
<p>ETH</p>
<p>bitcoin ：decentralized currency</p>
<p>ethereum: decentralized contract</p>
</blockquote>
<h4 id="以太坊账户"><a href="#以太坊账户" class="headerlink" title="以太坊账户"></a>以太坊账户</h4><blockquote>
<p>比特币中没有余额状态，每个币都要说明它的来源，交易的余额要换个地址存</p>
<p>以太坊内有账户余额的概念 account-based ledger,对双花有天然的防范作用，双花我二次扣费就行了。</p>
<p>以太坊会出现 replay attack ，解决办法是交易中增加计数器</p>
<p>外部账户：externally owned account(内包含：balance(账户余额) + nonce(计数器))</p>
<p>合约账户：smart contract account(balance(账户余额) + nonce(计数器)+code,storage)</p>
<p>合约可以调用合约，但是合约账户不能主动发起交易，创建合约的过程会返回一个地址，知道地址就可以调用合约啦</p>
<p>所有交易只能由外部账户发起，外部账户可以调用合约账户</p>
<p>因为需要支持<strong>智能合约</strong>，所以比特币不方便，比特币地址随时变化，没有固定的身份，以太坊要求参与者有比较稳定的身份。</p>
</blockquote>
<h4 id="以太坊的状态树"><a href="#以太坊的状态树" class="headerlink" title="以太坊的状态树"></a>以太坊的状态树</h4><blockquote>
<p>从账户地址到账户状态（外部账户和合约账户的状态）的映射</p>
<p>addr ——&gt; state 地址对应状态，直观想法是通过hash表来实现</p>
<p>状态树中保存（key,value）pair,MPT是管理key（即地址）的管理方式，value即账户状态，到底是怎么存储到状态树上。要经过一个rlp（递归长度编码做序列化）序列化，之后再存储。</p>
<p>protocal buffer(protobuf,pb) 著名的做序列化的库</p>
<p>RLP 只支持 nested array of bytes,即字节组成的数组，可以嵌套，以太坊中数据最终都要变成nested array of bytes</p>
<p>三棵树放到header,保证全节点本地的数据结构状态一致。</p>
<p>trie  字典树</p>
<p>以太坊地址格式 40位16进制（公钥的hash）</p>
<p><img src="/images/Blockchain-basics.assets/image-20221106211347241.png" srcset="/img/loading.gif" lazyload alt="image-20221106211347241"></p>
<p><img src="/images/Blockchain-basics.assets/image-20221106211406571.png" srcset="/img/loading.gif" lazyload alt="image-20221106211406571"></p>
<p>fabric项目</p>
</blockquote>
<h4 id="权益证明"><a href="#权益证明" class="headerlink" title="权益证明"></a>权益证明</h4><blockquote>
<p>比特币，工作量证明，很浪费资源和电力</p>
<p>能耗一定时必须的吗？挖矿的多少最本质就是投入钱的多少，那我们直接把钱拿出来比一比，把钱投入区块链开发，将来按照资金投入多少来分配收益。——POS 权益证明 proof of stack ，又称虚拟挖矿 virtual mining</p>
<p>比特币的挖矿资金是从区块链外部世界获得的，其资金其实只占世界资产的一小部分，如果真的有恶意攻击，很容易集齐51%的算力来攻击，使得比特币市值下降，对于比特币来说，其算力还是比较强大，但是对于一些刚刚发行的小货币，无法抵抗这种攻击。</p>
<p>POS 怎么对抗攻击？——情况有何不同，权益证明是按照拥有的币的总量进行投票，如果某个人想恶意攻击，他首先要获得币总发行量的一半以上，恶意者的资源只能从区块链内部得到，闭环。如果大量买入货币来进行攻击的话，价格会上涨。也有小货币用混合模式，挖矿难度和拥有币有关联，proof of deposit。</p>
<p>早期权益证明遇到的问题：nothing at stack 两头下注？  </p>
<p>以太坊中采用的权益证明（过渡阶段和pow混用）：Casper the Friendly Finality Gadget(FFG),引入一个概念，Validator验证者，投票决定哪个链是最长合法链，投票权重取决于保证金。验证者可以得到奖励，行政不作为/乱作为 会扣费。</p>
<p>以太坊的设计：逐渐从工作量证明过渡到权益证明，使得工作量证明的奖励越来越少</p>
<p>EOS：之前就是完全用权益证明，还在探索，不知道现在凉了没</p>
<p><strong>误区</strong>：认为比特币挖矿耗费电能，挖矿消耗的电其实占比不是很多。但其实电能很难存储，挖矿提供了将电转换成钱的手段。用电高峰电不够用，但是非高峰期，电能过剩，很多大型数据中心建立在电比较便宜的地方，因为传输数据比传输电容易。很多风力发电站的电除了满足当地用电，很难传输回主电网。主电网往边缘地区送电容易，但这些清洁能源的电发回主电网不是很容易，需要电网改造。</p>
</blockquote>
<h4 id="智能合约"><a href="#智能合约" class="headerlink" title="智能合约"></a>智能合约</h4><blockquote>
<p><img src="/images/Blockchain-basics.assets/image-20221104212616029.png" srcset="/img/loading.gif" lazyload alt="image-20221104212616029"></p>
<p>solidity是面向对象编程语言</p>
<p>bidders.push(bidder)是一个动态可改变的数组</p>
<p>拍卖时，调用bid函数，此时比特币也发送过去锁定，所以bid函数要能够接收外部转账的能力，后面加payable</p>
<p>withdraw，将自己的出价取回来</p>
<p><img src="/images/Blockchain-basics.assets/image-20221104212704927.png" srcset="/img/loading.gif" lazyload alt="image-20221104212704927"></p>
</blockquote>
<p>怎么调用智能合约？</p>
<p>转账地址如果为智能合约，则为调用函数，并不是要转账</p>
<blockquote>
<p><img src="/images/Blockchain-basics.assets/image-20221104213203037.png" srcset="/img/loading.gif" lazyload alt="image-20221104213203037"></p>
<p>要先用外部账户调用B中的函数</p>
<p><img src="/images/Blockchain-basics.assets/image-20221104213344864.png" srcset="/img/loading.gif" lazyload alt="image-20221104213344864"></p>
<p><img src="/images/Blockchain-basics.assets/image-20221104213443852.png" srcset="/img/loading.gif" lazyload alt="image-20221104213443852"></p>
<p><img src="/images/Blockchain-basics.assets/image-20221104213615099.png" srcset="/img/loading.gif" lazyload alt="image-20221104213615099"></p>
<p>data域为空，即没有指明调用智能合约哪个函数，就调用fallback</p>
<p><img src="/images/Blockchain-basics.assets/image-20221104214048239.png" srcset="/img/loading.gif" lazyload alt="image-20221104214048239"></p>
<p>通过加一层虚拟机，增强可移植性，对智能合约的运行提供一个一致性平台</p>
<p><img src="/images/Blockchain-basics.assets/image-20221104214645320.png" srcset="/img/loading.gif" lazyload alt="image-20221104214645320"></p>
<p>​    汽油费，智能合约是图灵完备的编程模型</p>
<p>出现死循环怎么办？</p>
<p><img src="/images/Blockchain-basics.assets/image-20221106114602715.png" srcset="/img/loading.gif" lazyload alt="image-20221106114602715"></p>
<p>以太坊中的交易有原子性，普通交易or智能合约调用都是如此</p>
<p><img src="/images/Blockchain-basics.assets/image-20221106115103753.png" srcset="/img/loading.gif" lazyload alt="image-20221106115103753"></p>
<p>连锁式回滚</p>
<p><img src="/images/Blockchain-basics.assets/image-20221106115341448.png" srcset="/img/loading.gif" lazyload alt="image-20221106115341448"></p>
<p>gaslimit:每个矿工在发布区块时可以微调</p>
<p><img src="/images/Blockchain-basics.assets/image-20221106115444823.png" srcset="/img/loading.gif" lazyload alt="image-20221106115444823"></p>
<p>假设某个全节点要打包一个交易到区块里，交易里面有一些是对智能合约的调用，全节点应该<strong>先执行智能合约？还是先挖矿？</strong>——首先明确，一个智能合约应该是要被所有全节点都执行的，不然状态会不一样。应该先执行所有智能合约，得到root,Txhash,ReceiptHash三棵树的根hash值，才能确定block header,才能开始挖矿。 </p>
<p>状态树（每个账户状态，包括余额），交易树，收据树，三棵树都保存在全节点本地数据结构，扣gas费时，多个全节点在本地数据结构中将gas费扣除。智能合约任何对状态的修改都是在改本地的数据结构，只有在智能合约执行完了，而且发布到区块链上之后，本地修改才外部可见，才会变成共识。</p>
<p>当接收交易时，每个全节点接收的交易可能不一样，但是就按照自己的执行，然后挖矿，直到某个块已经挖出来了，丢弃本地的计算，将块上的智能合约再执行一遍，更新本地的三棵树。 </p>
<p><strong>会不会有全节点不验证发布的区块的合法性？</strong>——不验证会威胁区块链安全。不会出现这个情况，如果不验证，本地三棵树无法更新，以后没法挖矿了。发布的区块上只有根hash值，没有三棵树的具体内容，所以每个全节点必须独立验证，更新自己的本地状态。 </p>
<p><strong>发布到区块链上的交易是否一定成功执行？</strong>——不一定，因为要扣gas费</p>
<p>如何知道交易是否执行成功，每个交易形成一个收据，如下图，status表明交易执行情况。</p>
<p><img src="/images/Blockchain-basics.assets/image-20221106150032510.png" srcset="/img/loading.gif" lazyload alt="image-20221106150032510"></p>
<p><strong>智能合约是否支持多线程？——solidity不支持多线程。</strong></p>
<p>以太坊是交易驱动的状态机——该<strong>状态机必须完全确定</strong>，给定一个智能合约，面对同一组输入，产生的输出/转移到的下一个状态必须完全一致。因为每个全节点都要执行和验证。</p>
<p>多线程——对内存访问顺序不同，执行结果可能是不确定的。</p>
<p>所有不确定的操作都不可以，所以智能合约无法产生真正意义上的随机数，不然每个全节点产生的随机数不一样，可以用伪随机数。</p>
<p><strong>智能合约的执行必须是确定性的</strong>，每个全节点的执行环境不一样，所以不能像其他编程语言那样通过systemcall之类的方法得到环境信息</p>
<p><img src="/images/Blockchain-basics.assets/image-20221106150955674.png" srcset="/img/loading.gif" lazyload alt="image-20221106150955674"></p>
<p><img src="/images/Blockchain-basics.assets/image-20221106151243198.png" srcset="/img/loading.gif" lazyload alt="image-20221106151243198"></p>
<p>address.balance 账户余额</p>
<p>address.transfer 转入address钱</p>
<p><img src="/images/Blockchain-basics.assets/image-20221106151447135.png" srcset="/img/loading.gif" lazyload alt="image-20221106151447135"></p>
</blockquote>
<p>拍卖例子</p>
<p>受益人：要拍卖东西的人</p>
<p>拍卖结束之前，每个人都能出价，竞拍时要把以太币发到智能合约锁住 </p>
<p><img src="/images/Blockchain-basics.assets/image-20221106152028684.png" srcset="/img/loading.gif" lazyload alt="image-20221106152028684"></p>
<p><img src="/images/Blockchain-basics.assets/image-20221106152306021.png" srcset="/img/loading.gif" lazyload alt="image-20221106152306021"></p>
<p>上述图片合约有问题吗？——看下图 （没看懂，继续搜搜？？）</p>
<blockquote>
<p>参数是拍卖合约的地址，调用拍卖合约中的bid函数，最后退款时auctionEnd只能看到hack地址，但是其中没有函数，只能调用fallback,引发异常，连锁回滚。——谁收不到钱了？</p>
<p>先明确转账是怎么转的，beneficiary.transfer把相应账户的余额进行了调整，所以回滚都回滚，转账就是修改本地数据结构，发布后其他矿工在改。此时回滚到合约执行之前，所有人都收不到钱。</p>
<p>这个hack有可能忘了写fallback函数</p>
</blockquote>
<p><img src="/images/Blockchain-basics.assets/image-20221106153236557.png" srcset="/img/loading.gif" lazyload alt="image-20221106153236557"></p>
<p>改进方法——第二版</p>
<p><img src="/images/Blockchain-basics.assets/image-20221106160223541.png" srcset="/img/loading.gif" lazyload alt="image-20221106160223541"></p>
<p>上图方法可行吗？——不行，重入攻击，递归调用，什么时候停止:拍卖账户上的钱不够了 or 汽油费不够了 or 调用栈溢出</p>
<p><img src="/images/Blockchain-basics.assets/image-20221106160519077.png" srcset="/img/loading.gif" lazyload alt="image-20221106160519077"></p>
<p><img src="/images/Blockchain-basics.assets/image-20221106161051158.png" srcset="/img/loading.gif" lazyload alt="image-20221106161051158"></p>
<h4 id="ETH-the-DAO"><a href="#ETH-the-DAO" class="headerlink" title="ETH - the DAO"></a>ETH - the DAO</h4><blockquote>
<p>DAO : Decentralized Autonomous Oraganization 去中心化的自治组织</p>
</blockquote>
<p>出现了一个组织叫 the  DAO ,本质是运行在以太坊上的智能合约，众筹。投入以太币，换回the DAO  的代币，用这些代币可以投票决定众筹的资金投入哪个项目，过一段时间内，通过拆分DAO,拿回资金和收益。</p>
<blockquote>
<p>DAC：Decentralized Autonomous Corporation</p>
</blockquote>
<p>拆分DAO 代码出了问题</p>
<blockquote>
<p>没有先把账户余额清0，重入攻击转走众筹的好多钱</p>
</blockquote>
<p><img src="/images/Blockchain-basics.assets/image-20221106164034705.png" srcset="/img/loading.gif" lazyload alt="image-20221106164034705"></p>
<p>因为28天锁定，所以还有补救机会，能不能从攻击交易开始回滚？——不现实，以太坊上还有很多合法交易，回滚全都作废了。（此处回滚指分叉），所以补救措施只能精确到那些攻击的交易上。</p>
<p>1.锁定黑客账户（凡是与the DAO 相关的账户不允许发生交易，软分叉（收到the Dao相关交易不打包）），此时以太坊软件没有收取这个额外判断是否与the  DAO账户相关的汽油费，因此受到很多攻击，恶意交易，浪费矿工计算资源，矿工纷纷回滚软件</p>
<p>2.用软件升级的方法，强行将theDAO上的资金转到一个新的智能合约，这个新的智能合约只有一个功能，退钱。强行重新记账，没有什么签名（硬分叉）</p>
<p>至此区块链分成了两个链，目前以太坊也是两条链并存。</p>
<p>旧链 ETC （Ethereum Classic）</p>
<p>硬分叉后 ETH</p>
<p>许多矿工仍留在旧链上挖矿，为了信仰，挖矿难度低</p>
<p>为了防止重放攻击，两条链有chainID 的区分</p>
<h4 id="反思"><a href="#反思" class="headerlink" title="反思"></a>反思</h4><blockquote>
<p>智能合约真的智能吗？</p>
</blockquote>
<p>修bug要通过硬分叉，很难搞，需要绝大部分矿工同意</p>
<p>区块链冻结账户需要软分叉，发布软件更新，凡是与改账户有关账户的交易不予打包。但个人的账户不可能给你这样补救。只能尽快转到新账户。</p>
<p>区块链上如果出现智能合约漏洞，没有办法阻止别人不去调用这个bug,要想阻止只能软分叉。或者尽快把钱转走。</p>
<p>Nothing is irrevocable.</p>
<p>智能合约未来的方向：智能合约模板，合约框架</p>
<p>为什么开源软件，全世界都能查看，还会出现漏洞？</p>
<p>Many eyeball fallacy.</p>
<p>手机上的区块链钱包代码也是开源的，但是用的人认真看过的没有几个。</p>
<p>去中心化反思：不满与中心化管理方式</p>
<p>What does decentralization mean？——硬分叉能够成功也是大部分矿工的共识。对规则的修改要用去中心化的方法来修改。</p>
<p>存在分叉的选项，恰恰是民主的体现。</p>
<p>去中心化 不等于 分布式：分布式系统不一定是去中心化的，去中心化是分布式的。</p>
<blockquote>
<p>比特币和以太坊都是状态机，让不同节点维护同一种状态，但分布式一般是让不同节点做不同的事情，然后将结果汇总成最终结果（提高速度）。</p>
</blockquote>
<p>状态机最早的应用是stock exchange、space shuttle这种需要一刻不停的提供服务的，即使某一台服务器宕机，其他服务器能够继续提供服务。</p>
<blockquote>
<p>重点思想：智能合约到底适用于什么样的场景，不要把Evm平台当作成大规模计算/存储的服务，速度很慢且昂贵，<strong>智能合约是用来编写控制逻辑的，只有那些在互不信任的实体之间建立共识的操作才适合写在智能合约里面</strong>。大规模计算可以用云服务平台。</p>
</blockquote>
<h4 id="美链"><a href="#美链" class="headerlink" title="美链"></a>美链</h4><blockquote>
<p>Beauty Chain</p>
<p><img src="/images/Blockchain-basics.assets/image-20221106192823012.png" srcset="/img/loading.gif" lazyload alt="image-20221106192823012"></p>
</blockquote>
<ul>
<li>ICO Initial Coin Offering</li>
<li>IPO Initial Public Offering</li>
<li>ERC EThereum Request for Comments</li>
</ul>
<blockquote>
<p><img src="/images/Blockchain-basics.assets/image-20221106193354921.png" srcset="/img/loading.gif" lazyload alt="image-20221106193354921"></p>
<p>第2行，如果value很大，给每个人发行的代币很大，乘法可能溢出，导致扣掉的amount很小，但是value还是照常发，相当于凭空多发了代币。攻击方式如下：</p>
<p><img src="/images/Blockchain-basics.assets/image-20221106194005112.png" srcset="/img/loading.gif" lazyload alt="image-20221106194005112"></p>
</blockquote>
<p>代码运算一定要仔细</p>
<blockquote>
<p><img src="/images/Blockchain-basics.assets/image-20221106194221468.png" srcset="/img/loading.gif" lazyload alt="image-20221106194221468"></p>
</blockquote>
<h3 id="2022-常驻-学习"><a href="#2022-常驻-学习" class="headerlink" title="2022/常驻/学习"></a>2022/常驻/学习</h3><h4 id="1-1密码学哈希函数-是-数学函数"><a href="#1-1密码学哈希函数-是-数学函数" class="headerlink" title="1.1密码学哈希函数 是 数学函数"></a>1.1密码学哈希函数 是 数学函数</h4><blockquote>
<p>输入可以是任意长度字符串，输出为固定长度字符串（fixed-size)</p>
<ol>
<li><p>无碰撞 collision-free  ： 找不到 x ,y 满足 hash(x) = hash(y) [但实际上不是找不到，而是找到要花费的时间很多，代价高，但是某些简单的hash函数很容易找到碰撞]</p>
<ol>
<li>若一个哈希函数被假设为collision-free,我们可以用它作为信息的摘要，例如比较两个长文件是否一致，直接比较hash值即可</li>
</ol>
</li>
<li><p>隐藏性 hiding : 已知 hash(x),不可能推断出 x. H(r|x)可以隐藏其输入值x, 我们从分散的分布中得到r, 然后与x连接，r|x是指将r的二进制位放到x后面 。r是从具有最小熵的分布中选择的随机值 high min-entropy(高阶最小熵描述了分布的分散程度)</p>
<ol>
<li><p>应用：commitment</p>
<blockquote>
<p>承诺一个数据，然后展示它，承诺协议方案由两个算法构成</p>
<p>1）将承诺信息放入承诺函数,然后得到两个返回值com(commitment承诺)和临时随机数 key（com,key）:=commit(msg) </p>
<p>2）展示信息，（公开key 和msg）任何人都可以通过key和msg来验证公布的msg是否为之前承诺的.match:=verify(com,key,msg)</p>
<p><img src="/images/Blockchain-basics.assets/image-20220816100406870.png" srcset="/img/loading.gif" lazyload alt="image-20220816100406870"></p>
<p>hash 的作用，com is the hash of key concatenated with msg</p>
<p><img src="/images/Blockchain-basics.assets/image-20220816100633628.png" srcset="/img/loading.gif" lazyload alt="image-20220816100633628"></p>
</blockquote>
</li>
</ol>
</li>
<li><p>puzzle-friendly： 对于每个可能输出的 y ，如果 k是从高阶最小熵分布中随机选取的，那么不可能找到 x，使其满足 H( k | x ) = y</p>
<blockquote>
<p><img src="/images/Blockchain-basics.assets/image-20220818085143127.png" srcset="/img/loading.gif" lazyload alt="image-20220818085143127"></p>
</blockquote>
</li>
</ol>
<p>哈希函数应用</p>
<p>SHA-256</p>
<p>1） 将你需要hash的信息分为 512bit大小的 block,最后一块不足512bit时补足</p>
<p><img src="/images/Blockchain-basics.assets/image-20220818085755713.png" srcset="/img/loading.gif" lazyload alt="image-20220818085755713"></p>
</blockquote>
<h4 id="1-2-哈希指针及其应用"><a href="#1-2-哈希指针及其应用" class="headerlink" title="1.2 哈希指针及其应用"></a>1.2 哈希指针及其应用</h4><blockquote>
<p>哈希指针不但能告诉你数据的位置，还能判断数据是否遭到篡改</p>
<p>哈希指针指向某数据区块 + 记录了<strong>某个时间戳下该数据的hash值</strong><img src="/images/Blockchain-basics.assets/image-20220818093231959.png" srcset="/img/loading.gif" lazyload alt="image-20220818093231959"></p>
<p>key idea : 用哈希指针构建数据结构</p>
<p>1）用哈希指针来构建链表，该数据结构称为 ——<strong>区块链</strong></p>
<p>每个区块都能告诉我们上一个区块的值在哪以及这个值的摘要，以此来验证那个值是否被篡改。区块链 — 防篡改日志，修改中间某个区块的值，就要一连串改动链上所有的信息，但是最初的hash指针无法改变（创世区块）</p>
<p><img src="/images/Blockchain-basics.assets/image-20220818093443722.png" srcset="/img/loading.gif" lazyload alt="image-20220818093443722" style="zoom:67%;"></p>
<p>2）用哈希指针来构建二叉树——默克尔树  Merkle tree</p>
<p><img src="/images/Blockchain-basics.assets/image-20220818105756354.png" srcset="/img/loading.gif" lazyload alt="image-20220818105756354"></p>
<p>与区块链的不一样之处：若某人想要证明某数据是该树中的一部分，他只需要给出这些数据，然后层层往上验证，花费logn的时间</p>
<p>优点：a) 能存很多东西，但在根部只需要记住一个256bit的哈希值；b)在logn的时间内验证从属关系</p>
<p>哈希指针可以用来构建任何基于指针且没有环的数据结构</p>
</blockquote>
<h4 id="1-3-数字签名"><a href="#1-3-数字签名" class="headerlink" title="1.3 数字签名"></a>1.3 数字签名</h4><p>类似纸上的签名，数字签名需要满足：</p>
<blockquote>
<p>1）只有自己可以签署自己的签名，且在其他地方别人可以验证该签名的有效性(only you can sign, but anyone can verify )</p>
<p>2）签名和某份特征文件绑定，不能剪下来粘贴</p>
<p>可验证  +  不可伪造</p>
</blockquote>
<p>如何利用密码学创造数字化形式的签名</p>
<blockquote>
<p>三种操作 - 组成数字签名方案</p>
<p>1）在一开始生成密钥，输入keysize ,得到 sk,pk</p>
<p>sk 为私钥，用来签署签名； pk为公钥，用于验证签名</p>
<p>2）签署，用sk签署签名，得到sign签名（一串表示你的签名的字符串</p>
<p>3）验证，接受声称有效的签名，用pk验证</p>
<p>注：前两个可以是随机算法，验证是确定的</p>
<p><img src="/images/Blockchain-basics.assets/image-20220818112731881.png" srcset="/img/loading.gif" lazyload alt="image-20220818112731881"></p>
</blockquote>
<p>数字签名在实践中需要关注的点</p>
<blockquote>
<p>1）需要选择好的随机发生算法，否则容易泄露私钥导致不安全<br>2）注意消息长度限制，实践中通常不是对消息本身而是对消息的哈希结果进行签名，消息的hash值作为数字签名的输入<br>3）可以签署一个hash指针。如果对区块链最后一个哈希指针签名，相当于保证了整个指针结构及块链正确性，为该区块链的全部内容赋予了一个有效的数字签名</p>
<p><img src="/images/Blockchain-basics.assets/image-20220818155712239.png" srcset="/img/loading.gif" lazyload alt="image-20220818155712239"></p>
</blockquote>
<p>比特币使用的特定的数字签名方案——ECDSA</p>
<blockquote>
<p>ECDSA涉及到复杂的数学，良好的随机性对其非常重要</p>
<p>Elliptic Curve Digital Signature Algorithm  椭圆曲线数字签名算法 </p>
</blockquote>
<h4 id="1-4-公钥作为身份标识"><a href="#1-4-公钥作为身份标识" class="headerlink" title="1.4 公钥作为身份标识"></a>1.4 公钥作为身份标识</h4><blockquote>
<p>如果某个签名被公钥验证正确，这是一段特定信息上面的签名，公钥即”说” 出了这个信息，公钥代表了一种身份，可以去做出这种声明</p>
<p><img src="/images/Blockchain-basics.assets/image-20220818160942667.png" srcset="/img/loading.gif" lazyload alt="image-20220818160942667"></p>
<p>解释：在系统中可以利用数字签名方案生成公钥和私钥，公钥作为公开身份的名字（即声明身份，实践中通常用公钥的哈希值，公钥通常比较大），私钥作为这个身份的声明/证明，因为我有这个私钥，所有我拥有这个身份，同时，如果公钥的生成方式足够随机，没有人知道你究竟是谁。</p>
<p><img src="/images/Blockchain-basics.assets/image-20220818164019025.png" srcset="/img/loading.gif" lazyload alt="image-20220818164019025"></p>
<p>以上就引导出一个去中心化身份管理的概念，无须注册身份或者名字，如果想要生成一个新身份，直接生成identity就行（公私钥）</p>
<p><strong>这些 identity 在区块链中称为地址</strong>（实际上就是一个公钥或者是公钥的哈希值）</p>
<p>身份的隐私性：</p>
<ol>
<li>identity和现实世界中的身份毫无关联</li>
<li>多次声明，行为方式可能会被观察者推断出现实身份</li>
</ol>
</blockquote>
<h4 id="1-5-简单的加密货币"><a href="#1-5-简单的加密货币" class="headerlink" title="1.5 简单的加密货币"></a>1.5 简单的加密货币</h4><h5 id="GoofyCoin"><a href="#GoofyCoin" class="headerlink" title="GoofyCoin"></a>GoofyCoin</h5><p>运行规则：</p>
<blockquote>
<ol>
<li><p>Goofy可以创造新的硬币</p>
<blockquote>
<p>CreateCoin 操作，生成币编号，，并且有一个Goofy签署的数字签名，任何人都能验证它</p>
</blockquote>
</li>
<li><p>高飞币可以被花掉，从一个到另一个人</p>
<blockquote>
<p>现有一个高飞币，加入一个指向其队hash指针，同时goofy做出将其付给Alice的声明（Alice被一个公钥代表），付给的动作由hash指针代表，同时Goofy签署签名，完成之后Alice成为这个高飞币的主人。</p>
<p>交易可以一直下去，通过检查hash指针链可以确保有效性</p>
<p><img src="/images/Blockchain-basics.assets/image-20220818165614862.png" srcset="/img/loading.gif" lazyload alt="image-20220818165614862"></p>
<p><img src="/images/Blockchain-basics.assets/image-20220818170118103.png" srcset="/img/loading.gif" lazyload alt="image-20220818170118103"></p>
</blockquote>
</li>
</ol>
<p>高飞币解决不了双重支付问题，并不安全，而这正是加密货币设计的关键问题之一</p>
<p><img src="/images/Blockchain-basics.assets/image-20220818170515230.png" srcset="/img/loading.gif" lazyload alt="image-20220818170515230"></p>
</blockquote>
<h5 id="ScroogeCoin"><a href="#ScroogeCoin" class="headerlink" title="ScroogeCoin"></a>ScroogeCoin</h5><blockquote>
<p>ScroogeCoin会公开所有的货币交易记录</p>
<p>说明：iD 为 73的区块记录了当前的交易信息，并有一个 hash指针指向之前的交易信息，ScroogeCoin会在最后代表着全部交易的哈希指针上签名并发布，任何人可以验证。（实际区块链中，每个区块记录了多个交易信息）</p>
<p>公开交易记录可以防止双重支付现象，任何人都可以验证交易链</p>
<p><img src="/images/Blockchain-basics.assets/image-20220818170954917.png" srcset="/img/loading.gif" lazyload alt="image-20220818170954917"></p>
<p>两种交易：</p>
<p>创币交易</p>
<p><img src="/images/Blockchain-basics.assets/image-20220819085759104.png" srcset="/img/loading.gif" lazyload alt="image-20220819085759104"></p>
<p>支付代币交易</p>
<p>如果交易合法，需要满足四个条件，满足后此次交易才有效，Scrooge将接受该交易，并将交易记录写进区块链，所有人都能看到。</p>
<p>注：代币不会改变，不会组合，不能分割，只是在某次交易中被创造，或被销毁（通过交易的方式获得代币组合或者分割点效果</p>
<p><img src="/images/Blockchain-basics.assets/image-20220819090015863.png" srcset="/img/loading.gif" lazyload alt="image-20220819090015863"></p>
<p>ScroogeCoin 的问题，如果Scrooge不诚信，系统将会出问题，我们能不能不要这个具有中心化管理的Scrooge，即不需要权威中心机构的加密货币。<strong>去中心化 ，但是依然能够提供Scrooge这样的服务。</strong><img src="/images/Blockchain-basics.assets/image-20220819090611351.png" srcset="/img/loading.gif" lazyload alt="image-20220819090611351"></p>
</blockquote>
<h4 id="2-1-去中心化的比特币"><a href="#2-1-去中心化的比特币" class="headerlink" title="2.1 去中心化的比特币"></a>2.1 去中心化的比特币</h4><blockquote>
<p>比特币实现去中心化的方法并不是完全依靠技术，是技术和巧妙激励机制的结合</p>
<p>没有彻底的去中心化和中心化，例如邮件系统，去中心化的，完全依靠SMTP协议，但是近年来被邮箱供应商控制（<strong>基于去中心化系统之上开发的应用服务可能是中心化的</strong>）</p>
</blockquote>
<p>去中心化面临的几个问题</p>
<blockquote>
<p>谁来维护账本？</p>
<p>谁来认证交易是否有效？</p>
<p>谁来创造新代币？</p>
<p>谁来决定系统的规则？</p>
<p>比特币如何取得汇率？</p>
</blockquote>
<p>点对点网络：任何人都可以运行比特币节点，去网上下载比特币客户端</p>
<p>挖矿：可以基于某挖矿生态系统中进行投入，并不是去中心化的</p>
<p>软件更新：核心开发员受社区信任，在决定电脑上使用什么比特币软件来运行节点时有很高的权限</p>
<h4 id="2-2-分布式共识"><a href="#2-2-分布式共识" class="headerlink" title="2.2 分布式共识"></a>2.2 分布式共识</h4><h4 id="2-3-没有身份共识的区块链"><a href="#2-3-没有身份共识的区块链" class="headerlink" title="2.3 没有身份共识的区块链"></a>2.3 没有身份共识的区块链</h4><blockquote>
<p>为什么比特币没有身份认证？（没有持久的长期身份）</p>
<p>身份认证在p2p网络很难：在去中心化的点对点网络，没有中央权威机构来给节点赋予身份，女巫攻击——恶意对手创建的节点副本，营造有很多不同参与者的假象，实际上全都由同一个对手控制</p>
<p>使用假名本就是比特币的目标之一</p>
</blockquote>
<p>区块链共识算法</p>
<blockquote>
<p>Alice想转账给Bob,她会创建一笔交易，并向所有节点广播这笔交易，任意一个节点都在持续不断接收着网络中的信息，并收集尚未纳入区块链的未完成交易列表。</p>
<p>某一时刻，这些节点中的某一个会被随机调用，用来提议下一个区块，它会收集所有未完成的交易，该节点可能是诚实的也可能是恶意的（）提议一个无效的交易。</p>
<p>其他节点将包含下一个区块的hash值，或者无视该区块转而去包含前一个他们认为有效的区块的hash值</p>
<p><img src="/images/Blockchain-basics.assets/image-20220822104845720.png" srcset="/img/loading.gif" lazyload alt="image-20220822104845720"></p>
</blockquote>
<p>双重支付</p>
<blockquote>
<p>ALice 付钱后，恰好轮到ALice 提议下一个区块，Alice提出一笔交易，是将钱付给另一个由她控制的节点，这个钱指向的区块链和之前付给Bob的是同一笔，也就是说同一笔钱，Alice想用两次，让她付给Bob的交易变成孤儿节点，但她已经获得了Bob的商品，实际Bob并没有收到钱。</p>
<p><img src="/images/Blockchain-basics.assets/image-20220822111654641.png" srcset="/img/loading.gif" lazyload alt></p>
<p>Bob怎么保护自己：零确认交易….放弃交易</p>
<p>最终防范双花现象靠的是共识机制，因为大部分节点都是诚实的，和密码学无关</p>
</blockquote>
<h4 id="2-4-激励机制与工作量证明"><a href="#2-4-激励机制与工作量证明" class="headerlink" title="2.4 激励机制与工作量证明"></a>2.4 激励机制与工作量证明</h4><p>给节点一个激励政策，保证它是诚实的？惩罚不诚实节点。</p>
<blockquote>
<p>节点是匿名的，没办法追踪去惩罚? 所以重点关注奖励最终留在长期共识链上的节点。</p>
<p>用比特币去激励创造了区块的节点</p>
<p><img src="/images/Blockchain-basics.assets/image-20220822112840189.png" srcset="/img/loading.gif" lazyload alt="image-20220822112840189"></p>
<p>2种激励机制</p>
<p>1）区块奖励：每个创造了区块的节点，都可以在该区块中包含一个特殊交易——比特币创建交易，可以自主选择交易的地址。（系统唯一产生新货币的方式）</p>
<p><img src="/images/Blockchain-basics.assets/image-20220822113318971.png" srcset="/img/loading.gif" lazyload alt="image-20220822113318971"></p>
<p>2）交易手续费：任何交易的创建者都会支付“小费”给那个将该交易写入下一个区块的节点</p>
<p><img src="/images/Blockchain-basics.assets/image-20220822113921326.png" srcset="/img/loading.gif" lazyload alt="image-20220822113921326"></p>
</blockquote>
<h4 id="遗留的问题"><a href="#遗留的问题" class="headerlink" title="遗留的问题"></a>遗留的问题</h4><blockquote>
<ol>
<li>如何随机选择节点？</li>
<li>如何避免每个人都想获得区块奖励的混战？</li>
<li>如何避免女巫攻击？</li>
</ol>
<p><img src="/images/Blockchain-basics.assets/image-20220822114014942.png" srcset="/img/loading.gif" lazyload alt="image-20220822114014942"></p>
<p><strong>工作量证明</strong>（以上问题都用这个解决）</p>
<p>不再随机随机选取节点，而是按照计算能力的比例来选择节点，让节点用自身的计算能力来相互竞争</p>
<p><img src="/images/Blockchain-basics.assets/image-20220822114554106.png" srcset="/img/loading.gif" lazyload alt="image-20220822114554106"></p>
<p>实现方法：hash pazzels</p>
<p>为了创建区块，提出该区块的节点，需要找到一个随机数（不会被轻易找到）（只能穷举）</p>
<p>这是节点在创造区块之前必须解决的数学难题</p>
<p><img src="/images/Blockchain-basics.assets/image-20220822115545201.png" srcset="/img/loading.gif" lazyload alt="image-20220822115545201"></p>
<p>hash power?</p>
</blockquote>
<h4 id="2-5-整合所有内容"><a href="#2-5-整合所有内容" class="headerlink" title="2.5 整合所有内容"></a>2.5 整合所有内容</h4>
                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/blockchain/" class="category-chain-item">blockchain</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/">#基础知识</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>Blockchain-basics</div>
      <div>https://yuwxl.github.io/2023/01/04/Blockchain-basics/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>nayun</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2023年1月4日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2023/01/04/Dcert/" title="DCert Towards Secure, Efficient, and Versatile Blockchain Light Clients">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">DCert Towards Secure, Efficient, and Versatile Blockchain Light Clients</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2023/01/04/lectures/" title="lectures">
                        <span class="hidden-mobile">lectures</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
